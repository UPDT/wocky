%%%
%%%               ejabberd configuration file
%%%
%%%'


%%%.   ================
%%%'   SERVED HOSTNAMES

%%
%% hosts: Domains served by ejabberd.
%%
%% {hosts, ["localhost"]}.


%%%.   ===============
%%%'   LISTENING PORTS

%%
%% listen: The ports ejabberd will listen on, which service each is handled
%% by and what options to start it with.
%%
{listen, [
  {5222, ejabberd_c2s, [
    {access, c2s},
    {shaper, c2s_shaper},
    {max_stanza_size, 65536}
  ]},

  {5269, ejabberd_s2s_in, [
    {shaper, s2s_shaper},
    {max_stanza_size, 131072}
  ]}
]}.

%%
%% S2S whitelist or blacklist
%%
%% Default s2s policy for undefined hosts.
%%
{s2s_default_policy, deny}.

%%
%% Allow or deny communication with specific servers.
%%
{outgoing_s2s_port, 5269}.


%%%.   ==============
%%%'   SESSION BACKEND

{sm_backend, {wocky, []}}.


%%%.   ==============
%%%'   AUTHENTICATION

%%
%% auth_method: Method used to authenticate the users.
%%
{auth_method, wocky}.
{auth_opts, [
  %% Store the passwords hashed for SCRAM:
  {password_format, scram},
  {scram_iterations, 4096} % default
]}.


%%%.   ===============
%%%'   TRAFFIC SHAPERS

%%
%% The "normal" shaper limits traffic speed to 1000 B/s
%%
{shaper, normal, {maxrate, 1000}}.

%%
%% The "fast" shaper limits traffic speed to 50000 B/s
%%
{shaper, fast, {maxrate, 50000}}.

%%
%% This option specifies the maximum number of elements in the queue
%% of the FSM. Refer to the documentation for details.
%%
{max_fsm_queue, 1000}.


%%%.   ====================
%%%'   ACCESS CONTROL LISTS

%%
%% Local users: don't modify this line.
%%
{acl, local, {user_regexp, ""}}.


%%%.   ============
%%%'   ACCESS RULES

%% Maximum number of simultaneous sessions allowed for a single user:
{access, max_user_sessions, [{10, all}]}.

%% Maximum number of offline messages that users can have:
{access, max_user_offline_messages, [{5000, admin}, {100, all}]}.

%% This rule allows access only for local users:
{access, local, [{allow, local}]}.

%% Only non-blocked users can use c2s connections:
{access, c2s, [{deny, blocked}, {allow, all}]}.

%% For C2S connections, all users except admins use the "normal" shaper
{access, c2s_shaper, [{none, admin}, {normal, all}]}.

%% All S2S connections use the "fast" shaper
{access, s2s_shaper, [{fast, all}]}.

%% All useres may look up their archived messages
{access, mam_lookup_messages, [{default, all}]}.


%%%.   ================
%%%'   DEFAULT LANGUAGE

%%
%% language: Default language used for server messages.
%%
{language, "en"}.


%%%.   =======
%%%'   MODULES

%%
%% Modules enabled in all ejabberd virtual hosts.
%% For list of possible modules options, check documentation.
%%
{modules, [
  %% Standard modules that clients will expect
  {mod_disco, []},
  {mod_ping, []},
  {mod_private, []}, % Some clients behave badly without this
  {mod_stream_management, [
    {buffer_max, 100},
    {ack_freq, 1},
    {resume_timeout, 600}
  ]},
  {mod_mam, []},

  %% Standard modules with custom wocky backends
  {mod_last, [{backend, wocky}]},
  {mod_offline, [
    {backend, wocky},
    {access_max_user_messages, max_user_offline_messages}
  ]},
  {mod_privacy, [{backend, wocky}]},

  %% New, Wocky-specific modules
  {mod_wocky_roster, []},
  {mod_wocky_version, []},
  {mod_wocky_debug, []},
  {mod_tros, [{backend, francus}, {scheme, "http://"}]},
  {mod_wocky_mam, []},
  {mod_wocky_token, []},
  {mod_wocky_rest,
   [{auth_providers, ["https://api.digits.com/1.1/sdk/account.json",
                      "http://localhost:9999"
                     ]},
    {auth_bypass_prefixes, [<<"+1555">>]}
   ]},
  {mod_wocky_user, []}
]}.


%%%.
%%%'

%%% Local Variables:
%%% mode: erlang
%%% End:
%%% vim: set filetype=erlang tabstop=2 foldmarker=%%%',%%%. foldmethod=marker:
%%%.
