%% -*- mode: Erlang; fill-column: 80; comment-column: 75; -*-
{plugins, [pc]}.

{erl_opts, [debug_info,
            {i, ["include"]}]}.

{require_otp_vsn, "1[78]"}.

{deps,
 [
  %% ejabberd dependencies
  {edown,         {git, "git://github.com/uwiger/edown.git",          {tag, "0.7"}}},
  {base16,        {git, "git://github.com/goj/base16.git",            {ref, "1e9dd2"}}},
  {cuesport,      {git, "git://github.com/esl/cuesport.git",          {ref, "d82ff2"}}},
  {redo,          {git, "git://github.com/JacobVorreuter/redo.git",   {ref, "7c7eae"}}},
  {exml,          {git, "git://github.com/esl/exml.git",              {tag, "2.2.0"}}},
  {lager,         {git, "git://github.com/basho/lager.git",           {ref, "b7984d4"}}},
  {cowboy,        {git, "git://github.com/ninenines/cowboy.git",      {tag, "1.0.1"}}},
  {folsom,        {git, "git://github.com/boundary/folsom.git",       {tag, "0.8.2"}}},
  {exometer,      {git, "git://github.com/esl/exometer.git",          {branch, "1.1-patched"}}},
  {mochijson2,    {git, "git://github.com/bjnortier/mochijson2.git",  {branch, "master"}}},
  {alarms,        {git, "git://github.com/toland/alarms.git",         {tag, "0.1.1"}}},
  {fusco,         {git, "git://github.com/esl/fusco.git",             {branch, "master"}}},
  {idna,          {git, "git://github.com/benoitc/erlang-idna.git",   {tag, "1.0.1"}}},

  {seestar,       {git, "git://github.com/bengtan/seestar.git",       {ref, "41927ab"}}},
  {protobuffs,    {git, "git://github.com/esl/erlang_protobuffs.git", {branch, "OTP18"}}},
  {riakc,         {git, "https://github.com/esl/riak-erlang-client",  {branch, "fix/dialyzer"}}},

  {p1_utils,      {git, "git://github.com/processone/p1_utils",       {ref, "940f42d"}}},
  {p1_cache_tab,  {git, "git://github.com/processone/cache_tab",      {ref, "7b89d6a"}}},
  {p1_stringprep, {git, "git://github.com/processone/stringprep.git", {ref, "9e9e0f8"}}},

  {proper,        {git, "git://github.com/manopapad/proper.git",      {ref, "20e62bc"}}},
  {meck,          {git, "git://github.com/eproxus/meck.git",          {tag, "0.8.3"}}},

  {pa,            {git, "git://github.com/lavrin/pa.git",             {ref, "c616d3f"}}},
  {ecoveralls,    {git, "git://github.com/nifoc/ecoveralls.git",      {ref, "40fa0d2"}}},
  {mustache,      {git, "git://github.com/mojombo/mustache.erl.git",  {ref, "d0246fe"}}},
  {recon,         {git, "git://github.com/ferd/recon.git",            {tag, "2.2.1"}}}
 ]}.

{overrides,
 [{override, setup, [{post_hooks, []}]},
  {override, riak_pb, [{pre_hooks, [{compile, "./rebar compile deps_dir=.."}]}]},
  {override, exometer,
   [{post_hooks, [{compile, "[ -f ../../../../include ] && mv ../../../../include include/EXOMETER-MIB.hrl"}]}]},
  {override, p1_stringprep,
   [{provider_hooks, [{pre, [{compile, {pc, compile}}, {clean, {pc, clean}}]}]}]},
  {override, exml,
   [{provider_hooks, [{pre, [{compile, {pc, compile}}, {clean, {pc, clean}}]}]}]},
  {override, ejabberd,
   [{pre_hooks, [{compile, "erlc -o ./src -I ./include +noobj ./asn1/*"}]},
    {provider_hooks, [{pre, [{compile, {pc, compile}}, {clean, {pc, clean}}]}]}
   ]}
 ]}.

{profiles,
 [{prod, [{relx, [{dev_mode, false},
                  {include_erts, true},
                  {include_src, false}]}]},

  {test_node1, [{relx, [{vm_args, "config/test_node1/vm.args"},
                        {overlay, [{mkdir, "log/sasl"},
                                   {copy, "bin", "."},
                                   {copy, "config/test_node1/ejabberd.cfg", "priv/ejabberd.cfg"},
                                   {copy, "config/fake_cert.pem", "priv/ssl/fake_cert.pem"},
                                   {copy, "config/fake_key.pem", "priv/ssl/fake_key.pem"},
                                   {copy, "config/fake_server.pem", "priv/ssl/fake_server.pem"}
                                  ]}]}]},

  {test_node2, [{relx, [{vm_args, "config/test_node2/vm.args"},
                        {overlay, [{mkdir, "log/sasl"},
                                   {copy, "bin", "."},
                                   {copy, "config/test_node2/ejabberd.cfg", "priv/ejabberd.cfg"},
                                   {copy, "config/fake_cert.pem", "priv/ssl/fake_cert.pem"},
                                   {copy, "config/fake_key.pem", "priv/ssl/fake_key.pem"},
                                   {copy, "config/fake_server.pem", "priv/ssl/fake_server.pem"}
                                  ]}]}]}
 ]}.

{relx, [{release, {"wocky", semver},
         [wocky,
          ejabberd,
          seestar,
          fusco,
          p1_utils,
          p1_cache_tab,
          pa,
          cuesport,
          base16,
          alarms,
          idna,
          recon,
          setup,
          runtime_tools,
          xmerl
         ]},

        {dev_mode, true},
        {include_erts, false},

        {generate_start_script, false},
        {extended_start_script, false},

        {sys_config, "config/sys.config"},
        {vm_args, "config/vm.args"},

        {overlay, [{mkdir, "log/sasl"},
                   {copy, "bin", "."},
                   {copy, "config/ejabberd.cfg", "priv/ejabberd.cfg"},
                   {copy, "config/fake_cert.pem", "priv/ssl/fake_cert.pem"},
                   {copy, "config/fake_key.pem", "priv/ssl/fake_key.pem"},
                   {copy, "config/fake_server.pem", "priv/ssl/fake_server.pem"}
                  ]}
   ]}.
